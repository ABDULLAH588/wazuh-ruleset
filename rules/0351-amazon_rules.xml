<!--
  -  Amazon rules
  -  Created by Wazuh, Inc.
  -  Copyright (C) 2015-2020, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<!--
ID: 80200 - 80499
-->

<group name="amazon,aws,">


    <!-- AWS wodle -->
    <rule id="80200" level="0">
        <decoded_as>json</decoded_as>
        <field name="integration">aws</field>
        <description>AWS alert.</description>
        <options>no_full_log</options>
    </rule>


    <!-- Cloudtrail -->

    <!-- Filter by eventName: etc/lists/amazon/aws-eventnames -->
    <rule id="80202" level="3">
        <if_sid>80200</if_sid>
        <field name="aws.source">cloudtrail</field>
        <list field="aws.eventName" lookup="match_key">etc/lists/amazon/aws-eventnames</list>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName).</description>
        <group>aws_cloudtrail,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- If there is an error code: increase the level and change description -->
    <rule id="80203" level="4">
        <if_sid>80202</if_sid>
        <field name="aws.errorCode">\.+</field>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName). Error: $(aws.errorCode).</description>
        <group>aws_cloudtrail,pci_dss_10.6.1,amazon-error,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Specific rules -->

    <!-- Events with errors -->
    <rule id="80250" level="5">
        <if_sid>80203</if_sid>
        <field name="aws.errorCode">AccessDenied</field>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName). Error: $(aws.errorCode).</description>
        <group>aws_cloudtrail,pci_dss_10.6.1,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.6,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Events with no errors -->
    <rule id="80251" level="3">
        <if_sid>80202</if_sid>
        <field name="aws.eventName">DeleteObjects</field>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName).</description>
        <group>aws_cloudtrail,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <rule id="80252" level="10" frequency="22" timeframe="600">
        <if_matched_sid>80251</if_matched_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - high number of deleted object.</description>
        <mitre>
            <id>T1485</id>
        </mitre>
        <group>aws_cloudtrail,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Logins -->
    <rule id="80253" level="3">
        <if_sid>80202</if_sid>
        <field name="aws.eventName">ConsoleLogin</field>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - User Login Success.</description>
        <mitre>
            <id>T1078</id>
        </mitre>
        <group>aws_cloudtrail,authentication_success,pci_dss_10.2.5,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <rule id="80254" level="5">
        <if_sid>80253</if_sid>
        <field name="aws.responseElements.ConsoleLogin">Failure</field>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - User Login failed.</description>
        <group>aws_cloudtrail,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <rule id="80255" level="10" frequency="6" timeframe="360">
        <if_matched_sid>80254</if_matched_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - Possible breaking attempt (high number of login attempts).</description>
        <mitre>
            <id>T1110</id>
        </mitre>
        <group>aws_cloudtrail,authentication_failures,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- IAM -->
    <rule id="80260" level="5">
        <if_sid>80202</if_sid>
        <list field="aws.eventName" lookup="match_key" check_value="^IAM">etc/lists/amazon/aws-eventnames</list>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - IAM event.</description>
        <group>aws_cloudtrail,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <rule id="80261" level="10">
        <if_sid>80260</if_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - Possible Privilege Scalation</description>
        <field name="aws.eventName">CreateUser</field>
        <mitre>
            <id>T1136</id>
        </mitre>
        <group>aws_cloudtrail,account_creation,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Account Discovery -->
    <rule id="80262" level="5">
        <if_sid>80260</if_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - IAM Request.</description>
        <field name="aws.eventName">^Get|^List\w+</field>
        <group>aws_cloudtrail,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <rule id="80263" level="15" frequency="6" timeframe="360" >
        <if_matched_sid>80262</if_matched_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - Possible Account Discovery (high number of IAM requests).</description>
        <mitre>
            <id>T1087</id>
        </mitre>
        <group>aws_cloudtrail,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Account Manipulation -->
    <rule id="80264" level="5">
        <if_sid>80260</if_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - Possible Account Manipulation.</description>
        <mitre>
            <id>T1098</id>
        </mitre>
        <field name="aws.eventName">^Add|^Attach|^Update\w+</field>
        <group>aws_cloudtrail,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Permissions Group Discovery -->
    <rule id="80265" level="5">
        <if_sid>80262</if_sid>
        <description>AWS Cloudtrail: $(aws.eventSource) - $(aws.eventName) - Possible Permissions Group Discovery.</description>
        <mitre>
            <id>T1098</id>
        </mitre>
        <field name="aws.eventName">^List|^Get(\w*)Polic\w+</field>
        <group>aws_cloudtrail,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <options>no_full_log</options>
    </rule>

    <!-- Modify Infrastructure -->


</group>
